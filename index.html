<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–§–∞—Ä–º–∞-–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä v13.2 (Original + Count)</title>
<link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkZhcmltYS1BcmNoaXRlY3QiLAogICJzaG9ydF9uYW1lIjogIkZhcmltYSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjBmMmY1IiwKICAidGhlbWVfY29sb3IiOiAiIzJjM2U1MCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzI4NjQvMjg2NDcwMC5wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root { 
            --main-bg: #f0f2f5; --border-color: #000; --accent: #3498db; 
            --danger: #e74c3c; --success: #27ae60; --ai-color: #9b59b6; --panel-bg: #ffffff;
            --update-bg: #d35400; --copy-bg: #8e44ad;
        }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--main-bg); padding: 15px; margin-bottom: 50px; }

        .toolbar { 
            max-width: 1200px; margin: 0 auto 20px; background: var(--panel-bg); padding: 15px; 
            border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex; flex-wrap: wrap; gap: 15px; position: sticky; top: 10px; z-index: 1000;
        }
        .tool-group { border-right: 1px solid #eee; padding-right: 15px; display: flex; flex-direction: column; gap: 5px; }
        .tool-group:last-child { border: none; }
        .tool-group h4 { margin: 0 0 5px 0; font-size: 10px; text-transform: uppercase; color: #95a5a6; }
        
        button { cursor: pointer; border: none; border-radius: 4px; padding: 7px 12px; font-size: 11px; font-weight: bold; color: white; transition: 0.2s; }
        .btn-mode { background: #2c3e50; }
        .btn-ai { background: var(--ai-color); }
        .btn-add { background: var(--accent); }
        .btn-save { background: var(--success); }
        
        #btn-update { background: var(--update-bg); display: none; }
        #btn-save-as { background: var(--copy-bg); display: none; }

        .workspace { background: white; max-width: 1050px; margin: 0 auto; padding: 40px; border: 2px solid #000; min-height: 1100px; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.05); }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; min-height: 60px; }
        .design-mode .form-row { border: 1px dashed #ccc; padding: 5px; }

        .box { border: 1px solid var(--border-color); padding: 10px; position: relative; background: white; display: flex; flex-direction: column; flex: 1; min-width: 50px; }
        .box-title { font-weight: bold; font-size: 10px; text-transform: uppercase; margin-bottom: 5px; border-bottom: 1px solid #eee; }
        .box-content { flex-grow: 1; min-height: 25px; outline: none; font-size: 13px; line-height: 1.5; }

        .box-ctrl { display: none; position: absolute; top: -25px; right: 0; background: #333; padding: 3px; border-radius: 4px; z-index: 100; gap: 3px; }
        .design-mode .box-ctrl { display: flex; }
        .ctrl-btn { background: #555; font-size: 9px; padding: 2px 5px; color: #fff; border: none; cursor: pointer; }
        .color-pick { width: 24px; height: 18px; border: 1px solid #fff; cursor: pointer; padding: 0; background: none; vertical-align: middle; }

        .db-container { max-width: 1050px; margin: 30px auto; background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd; }
        .db-group-title { background: #ecf0f1; padding: 8px; margin: 10px 0; font-weight: bold; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; font-size: 14px; align-items: center; }
        
        /* –°—Ç–∏–ª—å —Å—á–µ—Ç—á–∏–∫–∞ */
        .db-counter { background: var(--accent); color: white; padding: 1px 7px; border-radius: 10px; font-size: 10px; margin-left: auto; margin-right: 10px; }

        .db-item { display: flex; justify-content: space-between; padding: 5px 20px; border-bottom: 1px solid #f9f9f9; align-items: center; font-size: 13px; }

        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 15px; box-shadow: 0 0 50px rgba(0,0,0,0.5); z-index: 2000; width: 450px; }
        .modal input, .modal textarea { width: 100%; margin: 10px 0; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px; }
        .opt-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; max-height: 150px; overflow-y: auto; padding: 5px; border: 1px inset #f9f9f9; }
        .opt-btn { background:#f8f9fa; color:#2c3e50; border:1px solid #dee2e6; padding:6px 12px; cursor:pointer; font-size:12px; border-radius:4px; }

      @media print { 
            .toolbar, .box-ctrl, .ai-modal, .db-container { display: none !important; } 
            body { background: white; padding: 0; } 
            .workspace { border: 1px solid #000; width: 100%; max-width: none; box-shadow: none; margin: 0; padding: 10px; } 
        }
/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (—É—Å–∏–ª–µ–Ω–Ω–∞—è) */
@media screen and (max-width: 768px) {
    .toolbar { 
        flex-direction: column; 
        gap: 12px;
        padding: 10px;
    }
    
    .tool-group { 
        border-right: none; 
        border-bottom: 2px solid #f0f2f5; 
        padding-bottom: 15px; 
        display: flex;
        flex-direction: column;
        gap: 8px; /* –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã */
    }

    .tool-group h4 {
        font-size: 14px; /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –≥—Ä—É–ø–ø –∫—Ä—É–ø–Ω–µ–µ */
        margin-bottom: 5px;
        color: #7f8c8d;
    }

    /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∞–º–∏ –∫–Ω–æ–ø–∫–∏ */
    button { 
        padding: 16px 20px !important; /* –ë–æ–ª—å—à–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è –Ω–∞–∂–∞—Ç–∏—è */
        font-size: 16px !important;    /* –ö—Ä—É–ø–Ω—ã–π —Ç–µ–∫—Å—Ç */
        width: 100%;                   /* –ö–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ */
        border-radius: 8px;            /* –ë–æ–ª–µ–µ –º—è–≥–∫–∏–µ —É–≥–ª—ã */
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–æ–≤ (‚ÜîÔ∏è, ‚ùå) */
    .ctrl-btn {
        padding: 10px 15px !important;
        font-size: 18px !important;
    }

    .workspace { 
        padding: 10px !important; 
        margin: 5px !important;
        width: calc(100% - 10px) !important;
        box-sizing: border-box;
    }

    /* –ß—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –≤ —è—á–µ–π–∫–∞—Ö —Ç–æ–∂–µ –±—ã–ª–æ —É–¥–æ–±–Ω–æ —á–∏—Ç–∞—Ç—å –∏ –ø—Ä–∞–≤–∏—Ç—å */
    .box-content {
        font-size: 16px !important;
        min-height: 40px;
    }
}
input[type="checkbox"].db-check {
    transform: scale(1.5); /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∞–º—É –≥–∞–ª–æ—á–∫—É –≤ 1.5 —Ä–∞–∑–∞ */
    margin-right: 10px;
}
/* –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ */
.row-ctrl {
    display: none;
    position: absolute;
    left: -40px;
    top: 50%;
    transform: translateY(-50%);
    flex-direction: column;
    gap: 2px;
}
.design-mode .row-ctrl { display: flex; }
.row-btn {
    background: #34495e;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px;
    cursor: pointer;
    font-size: 12px;
}
.row-btn:hover { background: var(--accent); }
/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
.db-group-wrapper[draggable="true"] .db-group-title {
    cursor: grab;
    border: 1px dashed var(--accent);
}
.db-group-wrapper[draggable="true"] .db-group-title:active {
    cursor: grabbing;
    opacity: 0.5;
}
/* –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –∑–∞–∂–∞—Ç–∏–∏ –≥—Ä—É–ø–ø—ã –≤ —Ä–µ–∂–∏–º–µ Custom */
.db-group-wrapper.touch-active {
    touch-action: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    position: relative;
    z-index: 10000;
}
    </style>
</head>
<body>

<div class="toolbar">
    <div class="tool-group">
        <h4>ü§ñ –ò–ò</h4>
        <button class="btn-ai" onclick="openModal('ai-modal')">ü§ñ –ò–ò-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</button>
    </div>
    <div class="tool-group">
        <h4>üé® –†–µ–∂–∏–º</h4>
        <button id="mode-toggle" class="btn-mode" onclick="toggleDesignMode()">üõ†Ô∏è –ö–û–ù–°–¢–†–£–ö–¢–û–†: –í–´–ö–õ</button>
    </div>
    <div class="tool-group">
        <h4>üß± –ë–ª–æ–∫–∏</h4>
        <button class="btn-add" onclick="addNewRow()">‚ûï –°—Ç—Ä–æ–∫–∞</button>
        <button class="btn-add" style="background:#2980b9" onclick="addBoxWithTitle()">üì¶ –ë–ª–æ–∫</button>
    </div>
    <div class="tool-group">
        <h4>üíæ –•—Ä–∞–Ω–µ–Ω–∏–µ</h4>
        <button id="btn-save-new" class="btn-save" onclick="startSaveSequence()">üìÅ –í –±–∞–∑—É –±—Ä–∞—É–∑–µ—Ä–∞</button>
        <button id="btn-update" onclick="updateExistingRecord()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ –ü–†–ê–í–ö–ò</button>
        <button id="btn-save-as" onclick="startSaveSequence()">üìù –ö–ê–ö –ù–û–í–´–ô (–ö–û–ü–ò–Ø)</button>
        <button style="background:#95a5a6" onclick="resetToNew()">üÜï –û—á–∏—Å—Ç–∏—Ç—å</button>
        <button style="background:#34495e" onclick="downloadProject()">üíæ –°–∫–∞—á–∞—Ç—å .html</button>
    </div>
<div class="tool-group">
    <h4>üìÇ –§–∞–π–ª</h4>
    <button style="background:#34495e" onclick="document.getElementById('import-file').click()">üì• –ò–º–ø–æ—Ä—Ç HTML</button>
    <input type="file" id="import-file" style="display:none" accept=".html" onchange="importHTML(this)">
</div>
<div class="tool-group">
    <h4>üì¶ –ë–∞–∑–∞ (JSON)</h4>
    <button style="background:#27ae60" onclick="exportFullDB()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –±–∞–∑—ã</button>
    <button style="background:#2980b9" onclick="document.getElementById('import-db-file').click()">üì• –ò–º–ø–æ—Ä—Ç –±–∞–∑—ã</button>
    <input type="file" id="import-db-file" style="display:none" accept=".json,application/json,text/plain" onchange="importFullDB(this)">
</div>
    <div class="tool-group">
        <h4>üñ®Ô∏è –í—ã–≤–æ–¥</h4>
        <button style="background:#e67e22" onclick="window.print()">üìÑ –ü–µ—á–∞—Ç—å –≤ PDF</button>
    </div>
</div>

<div class="workspace" id="form-canvas">
    <div class="form-row">
        <div class="box" style="flex: 2;">
            <div class="box-ctrl">
                <button class="ctrl-btn" onclick="resizeBox(this, 0.3)">‚ÜîÔ∏è</button>
                <input type="color" class="color-pick" onchange="this.parentElement.parentElement.style.background=this.value">
                <button class="ctrl-btn" style="background:red" onclick="this.closest('.box').remove()">‚ùå</button>
            </div>
            <div class="box-title" contenteditable="true">–ù–∞–∑–≤–∞–Ω–∏–µ (RUS/LAT/–¢–æ—Ä–≥)</div>
            <div class="box-content" contenteditable="true" id="f-name"></div>
        </div>
        <div class="box">
            <div class="box-title" contenteditable="true">–°–∏–Ω–æ–Ω–∏–º—ã / –ì—Ä—É–ø–ø—ã</div>
            <div class="box-content" contenteditable="true" id="f-syn"></div>
        </div>
    </div>
</div>

<div class="db-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin:0">üìÇ –í–∞—à–∞ –§–∞—Ä–º–∞-–ë–∞–∑–∞</h3>
        <button id="btn-bulk-delete" style="background: var(--danger); display: none;" onclick="deleteSelected()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    </div>

    <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
        <span style="font-size: 12px; color: #666;">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≥—Ä—É–ø–ø:</span>
        <select id="db-sort-mode" onchange="renderDB()" style="padding: 5px; border-radius: 5px; border: 1px solid #ddd; font-size: 12px; flex: 1;">
            <option value="date-desc">üïí –ü–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)</option>
            <option value="date-asc">üïì –ü–æ –¥–∞—Ç–µ (—Å—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É)</option>
            <option value="alpha">üî§ –ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É (–ê-–Ø)</option>
            <option value="custom">‚úçÔ∏è –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ (Drag & Drop)</option>
        </select>
    </div>

    <input type="text" id="db-search" placeholder="üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫..." onkeyup="filterDB()" ...>
    <div id="db-list"></div>
</div>
<div class="modal" id="ai-modal">
    <h3>ü§ñ –ò–ò-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
    <input type="text" id="ai-drug" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞...">
    <button class="btn-ai" style="width:100%" onclick="genPrompt()">1. –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ü—Ä–æ–º–ø—Ç</button>
    <textarea id="ai-import" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ JSON –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò..."></textarea>
    <button class="btn-save" style="width:100%" onclick="importAI()">2. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
    <button onclick="closeModal('ai-modal')" style="background:#ccc; color:black; width:100%; margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<div id="save-modal" class="modal">
    <h3 id="save-step-title">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</h3>
    <div id="save-options" class="opt-grid"></div>
    <input type="text" id="save-custom-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...">
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="btn-save" id="save-confirm-btn" style="flex: 1;">–î–∞–ª–µ–µ</button>
        <button onclick="closeModal('save-modal')" style="background:#ccc; color:black; flex: 1;">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    let isDesign = false;
    let currentEditingIndex = null;
    let draggedItem = null;
    let touchStartY = 0;

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ï–ñ–ò–ú–ê–ú–ò ---
    function toggleDesignMode() {
        isDesign = !isDesign;
        document.body.classList.toggle('design-mode');
        document.getElementById('mode-toggle').innerText = isDesign ? "üëÅÔ∏è –ö–û–ù–°–¢–†–£–ö–¢–û–†: –í–ö–õ" : "üõ†Ô∏è –ö–û–ù–°–¢–†–£–ö–¢–û–†: –í–´–ö–õ";
    }

    function addNewRow() {
        const row = document.createElement('div');
        row.className = 'form-row';
        row.style.position = 'relative';
        row.innerHTML = `
            <div class="row-ctrl">
                <button class="row-btn" onclick="moveRow(this, 'up')" title="–í–≤–µ—Ä—Ö">‚ñ≤</button>
                <button class="row-btn" onclick="moveRow(this, 'down')" title="–í–Ω–∏–∑">‚ñº</button>
            </div>
        `;
        document.getElementById('form-canvas').appendChild(row);
        return row;
    }

    function openModal(id) { document.getElementById(id).style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

   // --- –õ–û–ì–ò–ö–ê –ò–ò ---
    function genPrompt() {
        const drug = document.getElementById('ai-drug').value || "–ü—Ä–µ–ø–∞—Ä–∞—Ç";
        const structure = {};
        
        // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–ª–µ–π (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞—à–∏ —É–ª—É—á—à–µ–Ω–∏—è —Å ID)
        document.querySelectorAll('.box-content').forEach(el => {
            const title = el.parentElement.querySelector('.box-title').innerText;
            if (!el.id) el.id = "f-" + Math.random().toString(36).substr(2, 5);
            structure[el.id] = `–¥–∞–Ω–Ω—ã–µ –¥–ª—è "${title}"`;
        });

        const promptText = `–§–∞—Ä–º–∞–∫–æ–ª–æ–≥, –∑–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è "${drug}". –í–µ—Ä–Ω–∏ –°–¢–†–û–ì–û —á–∏—Å—Ç—ã–π JSON: ${JSON.stringify(structure)}`;
        
        // 1. –†–µ–∑–µ—Ä–≤–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ –ø–æ–ª–µ (–∫–∞–∫ –∏ –±—ã–ª–æ)
        const aiInput = document.getElementById('ai-import');
        aiInput.value = promptText;

        // 2. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∞–≤—Ç–æ-–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ü–ö –∏ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞—Ö)
        if (navigator.clipboard && window.isSecureContext) {
            // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–±
            navigator.clipboard.writeText(promptText).then(() => {
                alert("–ü—Ä–æ–º—Ç –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä! –í—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ —á–∞—Ç —Å –ò–ò.");
            }).catch(err => {
                fallbackCopyText(promptText);
            });
        } else {
            // –ó–∞–ø–∞—Å–Ω–æ–π —Å–ø–æ—Å–æ–± –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
            fallbackCopyText(promptText);
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º)
    function fallbackCopyText(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            alert("–ü—Ä–æ–º—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä! (—á–µ—Ä–µ–∑ fallback)");
        } catch (err) {
            alert("–ü—Ä–æ–º—Ç –≥–æ—Ç–æ–≤ –≤ –ø–æ–ª–µ –Ω–∏–∂–µ. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é.");
        }
        document.body.removeChild(textArea);
    }

    function importAI() {
        try {
            const data = JSON.parse(document.getElementById('ai-import').value);
            for (let id in data) { 
                if(document.getElementById(id)) document.getElementById(id).innerText = data[id]; 
            }
            closeModal('ai-modal');
        } catch (e) { alert("–û—à–∏–±–∫–∞ JSON. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å—Ç–∞–≤–∏–ª–∏ –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò."); }
    }

    // --- –û–¢–†–ò–°–û–í–ö–ê –ë–ê–ó–´ –ò –°–û–†–¢–ò–†–û–í–ö–ê ---
    function renderDB() {
        const list = document.getElementById('db-list');
        const sortMode = document.getElementById('db-sort-mode') ? document.getElementById('db-sort-mode').value : 'date-desc';
        const db = JSON.parse(localStorage.getItem('pharmaDB') || '[]');
        list.innerHTML = "";
        
        const grouped = db.reduce((acc, item, index) => {
            if (!acc[item.group]) acc[item.group] = { items: [], lastUpdate: 0 };
            acc[item.group].items.push({...item, index});
            acc[item.group].lastUpdate = Math.max(acc[item.group].lastUpdate, item.updatedAt || 0);
            return acc;
        }, {});

        let groupsArray = Object.keys(grouped).map(name => ({ name: name, data: grouped[name] }));

        if (sortMode === 'alpha') groupsArray.sort((a, b) => a.name.localeCompare(b.name));
        else if (sortMode === 'date-desc') groupsArray.sort((a, b) => b.data.lastUpdate - a.data.lastUpdate);
        else if (sortMode === 'date-asc') groupsArray.sort((a, b) => a.data.lastUpdate - b.data.lastUpdate);

        groupsArray.forEach(groupObj => {
            let gDiv = document.createElement('div');
            gDiv.className = 'db-group-wrapper';
            const isCustom = sortMode === 'custom';
            
            gDiv.innerHTML = `
                <div class="db-group-title" 
                     draggable="${isCustom}" 
                     onclick="toggleGroup(this)" 
                     ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)"
                     ontouchstart="touchStart(event)" ontouchmove="touchMove(event)" ontouchend="touchEnd(event)">
                    <span>üìÅ ${groupObj.name}</span>
                    <span class="db-counter">${groupObj.data.items.length} —à—Ç.</span>
                </div>
                <div class="db-group-content" style="display:none"></div>`;
            
            groupObj.data.items.forEach(item => {
                const iEl = document.createElement('div');
                iEl.className = 'db-item';
                iEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" class="db-check" data-index="${item.index}" onclick="event.stopPropagation(); toggleBulkDeleteBtn()">
                        <span><b>${item.subgroup}:</b> ${item.name}</span>
                    </div>
                    <div>
                        <button style="background:var(--accent)" onclick="loadFromDB(${item.index})">üìÇ</button>
                        <button style="background:var(--danger)" onclick="deleteFromDB(${item.index})">üóëÔ∏è</button>
                    </div>`;
                gDiv.querySelector('.db-group-content').appendChild(iEl);
            });
            list.appendChild(gDiv);
        });
        toggleBulkDeleteBtn();
    }

    function toggleGroup(el) {
        const content = el.nextElementSibling;
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
    }

    // --- DRAG & DROP (–ü–ö + –¢–ê–ß) ---
    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) { draggedItem = ev.target.closest('.db-group-wrapper'); }
    function drop(ev) { 
        ev.preventDefault();
        const target = ev.target.closest('.db-group-wrapper');
        if (target && draggedItem && target !== draggedItem) handleReorder(target);
    }

    function touchStart(ev) {
        if (document.getElementById('db-sort-mode').value !== 'custom') return;
        draggedItem = ev.target.closest('.db-group-wrapper');
        draggedItem.classList.add('touch-active');
    }
    function touchMove(ev) {
        if (!draggedItem) return;
        ev.preventDefault();
        const touch = ev.touches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        const targetGroup = target ? target.closest('.db-group-wrapper') : null;
        if (targetGroup && targetGroup !== draggedItem) handleReorder(targetGroup);
    }
    function touchEnd() {
        if (draggedItem) {
            draggedItem.classList.remove('touch-active');
            draggedItem = null;
            saveCustomOrder();
        }
    }

    function handleReorder(target) {
        const list = document.getElementById('db-list');
        const allNodes = Array.from(list.children);
        if (allNodes.indexOf(draggedItem) < allNodes.indexOf(target)) target.after(draggedItem);
        else target.before(draggedItem);
    }

    function saveCustomOrder() {
        const db = JSON.parse(localStorage.getItem('pharmaDB') || '[]');
        const newOrder = [];
        document.querySelectorAll('.db-group-title span:first-child').forEach(span => {
            const gName = span.innerText.replace('üìÅ ', '');
            newOrder.push(...db.filter(item => item.group === gName));
        });
        localStorage.setItem('pharmaDB', JSON.stringify(newOrder));
    }

    // --- –•–†–ê–ù–ï–ù–ò–ï –ò –°–û–•–†–ê–ù–ï–ù–ò–ï ---
    function updateToolbar() {
        const isEdit = currentEditingIndex !== null;
        document.getElementById('btn-save-new').style.display = isEdit ? 'none' : 'inline-block';
        document.getElementById('btn-update').style.display = isEdit ? 'inline-block' : 'none';
        document.getElementById('btn-save-as').style.display = isEdit ? 'inline-block' : 'none';
    }

    function updateExistingRecord() {
        let db = JSON.parse(localStorage.getItem('pharmaDB') || '[]');
        if (confirm("–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å?")) {
            db[currentEditingIndex].html = document.getElementById('form-canvas').innerHTML;
            db[currentEditingIndex].name = document.getElementById('f-name').innerText.trim();
            db[currentEditingIndex].updatedAt = Date.now();
            localStorage.setItem('pharmaDB', JSON.stringify(db));
            renderDB();
            alert("–ì–æ—Ç–æ–≤–æ!");
        }
    }

    function startSaveSequence() {
        const db = JSON.parse(localStorage.getItem('pharmaDB') || '[]');
        let selectedGroup = "";
        const options = document.getElementById('save-options');
        const input = document.getElementById('save-custom-input');
        const confirmBtn = document.getElementById('save-confirm-btn');

        const renderOpts = (list, callback) => {
            options.innerHTML = "";
            list.forEach(opt => {
                const b = document.createElement('button'); b.className = "opt-btn"; b.innerText = opt;
                b.onclick = () => { input.value = opt; callback(opt); };
                options.appendChild(b);
            });
        };

        const finalize = (sub) => {
            db.push({
                name: document.getElementById('f-name').innerText.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                group: selectedGroup, subgroup: sub,
                html: document.getElementById('form-canvas').innerHTML,
                updatedAt: Date.now()
            });
            localStorage.setItem('pharmaDB', JSON.stringify(db));
            currentEditingIndex = db.length - 1;
            renderDB(); updateToolbar(); closeModal('save-modal');
        };

        const groups = [...new Set(db.map(i => i.group))];
        renderOpts(groups, (g) => { 
            selectedGroup = g; 
            const subs = [...new Set(db.filter(i => i.group === g).map(i => i.subgroup))];
            renderOpts(subs, (s) => finalize(s));
            confirmBtn.onclick = () => finalize(input.value);
        });
        openModal('save-modal');
        confirmBtn.onclick = () => { selectedGroup = input.value; renderOpts([], (s)=>finalize(s)); };
    }

    function loadFromDB(index) {
        const db = JSON.parse(localStorage.getItem('pharmaDB'));
        document.getElementById('form-canvas').innerHTML = db[index].html;
        currentEditingIndex = index;
        updateToolbar(); window.scrollTo(0,0);
    }

    function deleteFromDB(index) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
            let db = JSON.parse(localStorage.getItem('pharmaDB'));
            db.splice(index, 1);
            localStorage.setItem('pharmaDB', JSON.stringify(db));
            renderDB();
        }
    }

    function filterDB() {
    const q = document.getElementById('db-search').value.toLowerCase();
    const groups = document.querySelectorAll('.db-group-wrapper');

    groups.forEach(group => {
        const items = group.querySelectorAll('.db-item');
        let hasVisibleItems = false;

        items.forEach(item => {
            const text = item.innerText.toLowerCase();
            if (text.includes(q)) {
                item.style.display = 'flex';
                hasVisibleItems = true;
            } else {
                item.style.display = 'none';
            }
        });

        // –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–ø–æ–∫
        const groupContent = group.querySelector('.db-group-content');
        if (q.length > 0) {
            if (hasVisibleItems) {
                group.style.display = 'block';
                groupContent.style.display = 'block'; // –ê–≤—Ç–æ-—Ä–∞—Å–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
            } else {
                group.style.display = 'none';
            }
        } else {
            // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥ (–ø–∞–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã)
            group.style.display = 'block';
            groupContent.style.display = 'none';
        }
    });
}
    function addBoxWithTitle() {
        const title = prompt("–ó–∞–≥–æ–ª–æ–≤–æ–∫:"); if (!title) return;
        const row = document.querySelector('.form-row:last-child') || addNewRow();
        const box = document.createElement('div'); box.className = 'box';
        box.innerHTML = `<div class="box-ctrl">
            <button class="ctrl-btn" onclick="resizeBox(this, 0.3)">‚ÜîÔ∏è</button>
            <input type="color" class="color-pick" onchange="this.parentElement.parentElement.style.background=this.value">
            <button class="ctrl-btn" style="background:red" onclick="this.closest('.box').remove()">‚ùå</button>
            </div><div class="box-title" contenteditable="true">${title}</div>
            <div class="box-content" contenteditable="true" id="f-${Date.now()}"></div>`;
        row.appendChild(box);
    }

    function resizeBox(btn, delta) {
        const box = btn.closest('.box');
        let f = parseFloat(getComputedStyle(box).flexGrow) || 1;
        box.style.flexGrow = Math.max(0.2, f + delta);
    }

    function moveRow(btn, direction) {
        const row = btn.closest('.form-row');
        if (direction === 'up' && row.previousElementSibling) row.parentNode.insertBefore(row, row.previousElementSibling);
        else if (direction === 'down' && row.nextElementSibling) row.parentNode.insertBefore(row.nextElementSibling, row);
    }

    function toggleBulkDeleteBtn() {
        const count = document.querySelectorAll('.db-check:checked').length;
        document.getElementById('btn-bulk-delete').style.display = count > 0 ? 'block' : 'none';
    }

    function deleteSelected() {
        let db = JSON.parse(localStorage.getItem('pharmaDB') || '[]');
        const idxs = Array.from(document.querySelectorAll('.db-check:checked')).map(c => parseInt(c.dataset.index)).sort((a,b)=>b-a);
        idxs.forEach(i => db.splice(i, 1));
        localStorage.setItem('pharmaDB', JSON.stringify(db));
        renderDB();
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    renderDB();
// --- –§–£–ù–ö–¶–ò–ò –≠–ö–°–ü–û–†–¢–ê –ò –ò–ú–ü–û–†–¢–ê –í–°–ï–ô –ë–ê–ó–´ (JSON) ---
function exportFullDB() {
    const db = localStorage.getItem('pharmaDB');
    if (!db || db === "[]") {
        alert("–ë–∞–∑–∞ –ø—É—Å—Ç–∞, –Ω–µ—á–µ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å.");
        return;
    }
    const blob = new Blob([db], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pharma_db_backup_${new Date().toLocaleDateString()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}
function importFullDB(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            if (!Array.isArray(importedData)) {
                alert("–û—à–∏–±–∫–∞: –§–∞–π–ª –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.");
                return;
            }

            let localDB = JSON.parse(localStorage.getItem('pharmaDB') || '[]');
            let addedCount = 0;
            let updatedCount = 0;

            importedData.forEach(newItem => {
                // –ò—â–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø—Ä–µ–ø–∞—Ä–∞—Ç (—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏, –≥—Ä—É–ø–ø–µ –∏ –ø–æ–¥–≥—Ä—É–ø–ø–µ)
                const existingIndex = localDB.findIndex(item => 
                    item.name === newItem.name && 
                    item.group === newItem.group && 
                    item.subgroup === newItem.subgroup
                );

                if (existingIndex !== -1) {
                    // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
                    localDB[existingIndex] = newItem;
                    updatedCount++;
                } else {
                    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –ø—Ä–µ–ø–∞—Ä–∞—Ç ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –≤ –±–∞–∑—É
                    localDB.push(newItem);
                    addedCount++;
                }
            });

            localStorage.setItem('pharmaDB', JSON.stringify(localDB));
            renderDB();
            alert(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!\n–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö: ${addedCount}\n–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö: ${updatedCount}`);
            
        } catch (err) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: " + err);
        }
    };
    reader.readAsText(file);
    input.value = '';
}

// --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° HTML-–§–ê–ô–õ–ê–ú–ò –ü–†–û–ï–ö–¢–û–í ---
function downloadProject() {
    const tempIndex = currentEditingIndex;
    currentEditingIndex = null;
    updateToolbar();

    const htmlContent = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
    const blob = new Blob([htmlContent], {type: 'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (document.getElementById('f-name').innerText.trim() || 'pharma_project') + ".html";
    a.click();

    currentEditingIndex = tempIndex;
    updateToolbar();
}

function importHTML(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(e.target.result, 'text/html');
        const newContent = doc.getElementById('form-canvas');
        if (newContent) {
            document.getElementById('form-canvas').innerHTML = newContent.innerHTML;
            currentEditingIndex = null;
            updateToolbar();
            alert("–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!");
        } else {
            alert("–û—à–∏–±–∫–∞: –í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞.");
        }
    };
    reader.readAsText(file);
    input.value = '';
}

function resetToNew() {
    if(confirm("–û—á–∏—Å—Ç–∏—Ç—å —Ä–∞–±–æ—á—É—é –æ–±–ª–∞—Å—Ç—å?")) {
        location.reload(); 
    }
}
</script>
    <script>
(function() {
  window.addEventListener('DOMContentLoaded', () => {
    const toolbar = document.querySelector('.toolbar');
    if (!toolbar) return;

    const voiceGroup = document.createElement('div');
    voiceGroup.className = 'tool-group';
    voiceGroup.innerHTML = `
      <h4>üéôÔ∏è –ì–æ–ª–æ—Å</h4>
      <button id="voice-btn-global" class="btn-ai" style="background: #2ecc71;">üé§ –ì–û–õ–û–°</button>
    `;
    toolbar.appendChild(voiceGroup);

    const voiceBtn = document.getElementById('voice-btn-global');
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      voiceBtn.style.opacity = '0.5';
      voiceBtn.title = "–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–æ–ª–æ—Å";
      return;
    }

    const recognition = new SpeechRecognition();
    recognition.lang = 'ru-RU';
    recognition.interimResults = false;
    recognition.continuous = true; // –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ

    let isListeningCommands = false;

    voiceBtn.onclick = () => {
      try {
        recognition.start();
        voiceBtn.style.background = '#e74c3c';
        voiceBtn.innerHTML = 'üî¥ –°–õ–£–®–ê–Æ';
      } catch (e) {
        recognition.stop();
        console.error(e);
      }
    };

    recognition.onresult = (event) => {
      let cmd = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
      cmd = cmd.replace(/[\s\.\,\;\:\!\?]+$/, ""); // —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∑–Ω–∞–∫–∏ –≤ –∫–æ–Ω—Ü–µ

      console.log("–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:", cmd);

      // –ï—Å–ª–∏ —Å–∫–∞–∑–∞–ª–∏ "–æ–∫–µ–π" ‚Äî –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º –∫–æ–º–∞–Ω–¥
      if (cmd.includes("–æ–∫–µ–π")) {
        isListeningCommands = true;
        console.log("‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ä–µ–∂–∏–º –∫–æ–º–∞–Ω–¥");
        return;
      }

      // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –∫–æ–º–∞–Ω–¥ –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ–º
      if (isListeningCommands) {
        // –ü–æ–∏—Å–∫
        if (cmd.includes("–Ω–∞–π–¥–∏") || cmd.includes("–ø–æ–∏—Å–∫")) {
          const query = cmd.replace(/(–Ω–∞–π–¥–∏|–ø–æ–∏—Å–∫|–ø—Ä–µ–ø–∞—Ä–∞—Ç)/g, "").trim();
          const searchInput = document.getElementById('db-search');
          if (searchInput) {
            searchInput.value = query;
            if (typeof filterDB === 'function') filterDB();
            searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }

        // –ü–µ—á–∞—Ç—å
        if (cmd.includes("–ø–µ—á–∞—Ç—å") || cmd.includes("—Ä–∞—Å–ø–µ—á–∞—Ç–∞–π")) {
          window.print();
        }

        // –û—á–∏—Å—Ç–∫–∞
        if (cmd.includes("–æ—á–∏—Å—Ç–∏—Ç—å") || cmd.includes("—Å–±—Ä–æ—Å") || cmd.includes("–Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç")) {
          resetToNew();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        if (cmd.includes("—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å") || cmd.includes("–∑–∞–ø–∏—à–∏") || cmd.includes("–≤ –±–∞–∑—É")) {
          startSaveSequence();
        }

        // –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
        if (cmd.includes("–Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞") || cmd.includes("–¥–æ–±–∞–≤—å —Å—Ç—Ä–æ–∫—É")) {
          addNewRow();
        }

        // –ù–æ–≤—ã–π –±–ª–æ–∫
        if (cmd.includes("–Ω–æ–≤—ã–π –±–ª–æ–∫") || cmd.includes("–¥–æ–±–∞–≤—å –±–ª–æ–∫")) {
          addBoxWithTitle();
        }

        // –†–µ–∂–∏–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
        if (cmd.includes("—Ä–µ–∂–∏–º") || cmd.includes("–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä")) {
          toggleDesignMode();
        }

        // –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º
        isListeningCommands = false;
        console.log("‚èπÔ∏è –†–µ–∂–∏–º –∫–æ–º–∞–Ω–¥ –∑–∞–≤–µ—Ä—à—ë–Ω");
      }
    };

    recognition.onend = () => {
      voiceBtn.style.background = '#2ecc71';
      voiceBtn.innerHTML = 'üé§ –ì–û–õ–û–°';
    };
  });
})();
</script>
</body>
</html>
